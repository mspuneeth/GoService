{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment - GoService</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background:#fff8f0; padding:20px; }
        .container { max-width:600px; margin:auto; background:#fff3e6; padding:30px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
        h2 { text-align:center; color:#ff6600; margin-bottom:25px; }
        .form-group { margin-bottom:15px; }
        label { font-weight:bold; }
        input, select { width:100%; padding:8px; margin-top:5px; border-radius:6px; border:1px solid #ccc; }
        button { margin-top:10px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Payment for {{ booking.service.service_type.profession_name }}</h2>
    <p><strong>Provider:</strong> {{ booking.provider.user.username }}</p>
    <p><strong>Amount:</strong> ₹{{ amount }}</p>

    <form method="POST" id="paymentForm">
        {% csrf_token %}
        
        <!-- Payment Option -->
        <div class="form-group">
            <label for="payment_method">Select Payment Method</label>
            <select id="payment_method" name="payment_method" class="form-select">
                <option value="">--Select--</option>
                <option value="cod">Cash on Delivery</option>
                <option value="upi">UPI</option>
                <option value="card">Debit Card</option>
            </select>
        </div>

        <!-- UPI Fields -->
        <div id="upiFields" style="display:none;">
            <div class="form-group">
                <label for="upi_id">UPI ID</label>
                <input type="text" id="upi_id" name="upi_id" placeholder="example@bank">
            </div>
            <button type="button" class="btn btn-secondary" id="upiClear">Clear</button>
            <button type="submit" class="btn btn-primary">Pay ₹{{ amount }}</button>
        </div>

        <!-- Card Fields -->
        <div id="cardFields" style="display:none;">
            <div class="form-group">
                <label for="card_number">Card Number</label>
                <input type="text" id="card_number" name="card_number" maxlength="10" placeholder="Enter 10 digit card number">
            </div>
            <div class="form-group">
                <label for="expiry_year">Expiry Year</label>
                <input type="number" id="expiry_year" name="expiry_year" min="2025" placeholder="2025">
            </div>
            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" name="cvv" maxlength="3" placeholder="123">
            </div>
            <button type="button" class="btn btn-secondary" id="cardClear">Clear</button>
            <button type="submit" class="btn btn-primary">Pay ₹{{ amount }}</button>
        </div>

        <!-- COD Button -->
        <div id="codFields" style="display:none; text-align:center;">
            <p>Pay with Cash on Delivery</p>
            <button type="submit" class="btn btn-primary">Pay ₹{{ amount }}</button>
        </div>
    </form>
</div>

<script>
    const paymentSelect = document.getElementById('payment_method');
    const upiFields = document.getElementById('upiFields');
    const cardFields = document.getElementById('cardFields');
    const codFields = document.getElementById('codFields');
    const form = document.getElementById('paymentForm');

    // URLs
    const codURL = "{% url 'cod_confirmation' booking.id %}";
    const successURL = "{% url 'payment_success' booking.id %}";

    paymentSelect.addEventListener('change', function() {
        upiFields.style.display = 'none';
        cardFields.style.display = 'none';
        codFields.style.display = 'none';

        if (this.value === 'upi') upiFields.style.display = 'block';
        else if (this.value === 'card') cardFields.style.display = 'block';
        else if (this.value === 'cod') codFields.style.display = 'block';
    });

    // Clear buttons
    document.getElementById('upiClear').addEventListener('click', function() {
        document.getElementById('upi_id').value = '';
    });
    document.getElementById('cardClear').addEventListener('click', function() {
        document.getElementById('card_number').value = '';
        document.getElementById('expiry_year').value = '';
        document.getElementById('cvv').value = '';
    });

    // Validation + dynamic redirect
    form.addEventListener('submit', function(e) {
        const method = paymentSelect.value;
        if (!method) { alert('Please select payment method'); e.preventDefault(); return; }

        if (method === 'upi') {
            const upi = document.getElementById('upi_id').value;
            if (!upi.includes('@')) { alert('Enter valid UPI ID'); e.preventDefault(); return; }
            form.action = successURL;  // redirect to success after UPI payment
        } 
        else if (method === 'card') {
            const card = document.getElementById('card_number').value;
            const year = parseInt(document.getElementById('expiry_year').value);
            const cvv = document.getElementById('cvv').value;
            if (card.length !== 10) { alert('Card number must be 10 digits'); e.preventDefault(); return; }
            if (year < 2025) { alert('Expiry year must be 2025 or later'); e.preventDefault(); return; }
            if (cvv.length !== 3) { alert('CVV must be 3 digits'); e.preventDefault(); return; }
            form.action = successURL;  // handled by payment_view -> success
        } 
        else if (method === 'cod') {
            form.action = codURL; // send to COD view
        }
    });
</script>

</body>
</html>
