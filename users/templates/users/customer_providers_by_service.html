{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ service_name }} Providers - GoService</title>
    <link rel="stylesheet" href="{% static 'main/style.css' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #fff8f0; margin:0; }
        .navbar { background-color: #ff9900; padding: 10px 20px; color: #fff; display:flex; align-items:center; }
        .navbar a { color:#fff; text-decoration:none; margin-right:15px; font-weight:bold; }
        .navbar .logo { font-family: 'Pacifico', cursive; font-size:1.8rem; margin-right:auto; cursor:pointer; }
        
        h2 { text-align:center; color:#ff6600; margin:25px 0; }

        .table-container { width:80%; margin:0 auto; background:#fff3e6; border-radius:10px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
        table { width:100%; border-collapse:collapse; text-align:center; }
        th, td { padding:12px; border-bottom:1px solid #ddd; }
        th { background-color:#ffb366; color:#fff; }
        td img { width:60px; height:60px; border-radius:50%; object-fit:cover; }
        tr:hover { background-color:#ffe0b3; }
        .buttons { margin-top:20px; text-align:center; }
        .book-btn, .back-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin:0 5px; }
        .book-btn { background:#ff6600; color:white; }
        .back-btn { background:#ccc; color:black; }

        /* Modal styles */
        .modal-header { background-color: #ff9900; color:white; }
        .modal-body label { font-weight:bold; }
        .profile-pic { width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:10px; }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
    <div class="logo" onclick="location.href='{% url 'customer_dashboard' %}'">GoService</div>
    <a href="{% url 'customer_dashboard' %}">Home</a>
    <a href="{% url 'customer_services' %}">Our Services</a>
    <a href="{% url 'customer_profile' %}">Profile</a>
    <a href="{% url 'logout' %}">Logout</a>
</div>

<h2>{{ service_name }} Providers</h2>

<div class="table-container">
    {% if providers %}
    <table>
        <tr>
            <th>Profile</th>
            <th>Provider Name</th>
            <th>Experience</th>
            <th>Price</th>
            <th>Address</th>
            <th>Phone</th>
            <th>Action</th>
        </tr>
        {% for provider in providers %}
        <tr>
            <td>
                {% if provider.provider.user.profile_pic %}
                    <img src="{{ provider.provider.user.profile_pic.url }}" alt="Profile">
                {% else %}
                    <img src="{% static 'main/lastfix1.png' %}" alt="Default">
                {% endif %}
            </td>
            <td>{{ provider.provider.user.username }}</td>
            <td>{{ provider.experience }}</td>
            <td>â‚¹{{ provider.price }}</td>
            <td>{{ provider.address }}</td>
            <td>{{ provider.phone }}</td>
            <td>
                {% if provider.service %}
                <button class="book-btn" 
                    data-bs-toggle="modal" 
                    data-bs-target="#bookModal"
                    data-provider="{{ provider.provider.user.username }}"
                    data-service="{{ service_name }}"
                    data-service-id="{{ provider.service.id }}"
                    data-provider-id="{{ provider.provider.id }}"
                >Book</button>
                {% else %}
                    <span style="color:red;">Service not listed</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
        <p style="text-align:center; color:#ff6600; font-weight:bold;">No providers available for this service.</p>
    {% endif %}
</div>

<div class="buttons">
    <button class="back-btn" onclick="location.href='{% url 'customer_services' %}'">Back</button>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookModalLabel">Book Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        {% if customer.profile_pic %}
            <img src="{{ customer.profile_pic.url }}" alt="Profile Picture" class="profile-pic">
        {% else %}
            <img src="{% static 'main/default_user.png' %}" alt="Profile" class="profile-pic">
        {% endif %}
        <p><strong>Name:</strong> {{ customer.username }}</p>
        <p><strong>Email:</strong> {{ customer.email }}</p>
        <p><strong>Phone:</strong> {{ customer.customer.phone }}</p>
        <p><strong>Address:</strong> {{ customer.customer.address }}</p>

        <form id="bookingForm">
            <div class="mb-3 text-start">
                <label for="timing">Select Timing</label>
                <select id="timing" class="form-select">
                    <option value="">-- Select --</option>
                    <option value="9AM-11AM">9AM-11AM</option>
                    <option value="11AM-1PM">11AM-1PM</option>
                    <option value="1PM-3PM">1PM-3PM</option>
                    <option value="3PM-5PM">3PM-5PM</option>
                    <option value="5PM-7PM">5PM-7PM</option>
                </select>
            </div>
            <div class="mb-3 text-start">
                <label for="schedule_date">Schedule Date</label>
                <input type="date" id="schedule_date" class="form-control">
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
                <button type="button" class="btn btn-primary" id="proceedBtn">Proceed</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
var bookModal = document.getElementById('bookModal');

// Set min-date to today
document.getElementById('schedule_date').setAttribute('min', new Date().toISOString().split('T')[0]);

// Populate modal when opening
bookModal.addEventListener('show.bs.modal', function(event) {
    var button = event.relatedTarget;
    var providerName = button.getAttribute('data-provider');
    var serviceName = button.getAttribute('data-service');
    var serviceId = button.getAttribute('data-service-id');
    var providerId = button.getAttribute('data-provider-id');

    var modalTitle = bookModal.querySelector('.modal-title');
    modalTitle.textContent = 'Book ' + serviceName + ' with ' + providerName;

    var proceedBtn = document.getElementById('proceedBtn');
    proceedBtn.dataset.serviceId = serviceId;
    proceedBtn.dataset.providerId = providerId;
});

// Clear button
document.getElementById('clearBtn').addEventListener('click', function() {
    document.getElementById('timing').value = '';
    document.getElementById('schedule_date').value = '';
});

// Proceed button: create booking and redirect to payment
document.getElementById('proceedBtn').addEventListener('click', function() {
    var serviceId = this.dataset.serviceId;
    var providerId = this.dataset.providerId;
    var schedule_date = document.getElementById('schedule_date').value;
    var timing = document.getElementById('timing').value;

    if (!schedule_date || !timing) {
        alert('Please select both date and timing.');
        return;
    }

    fetch("{% url 'create_booking' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `service_id=${serviceId}&provider_id=${providerId}&schedule_date=${schedule_date}&timing=${timing}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
         window.location.href = `/users/payment/${data.booking_id}/`;
        } else {
            alert(data.message);
        }
    });
});
</script>
</body>
</html>
